name: Rust CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build_and_test:
    name: Build, Test and Lint
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # 使用官方推荐的 Rust setup action
    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        components: rustfmt, clippy
        # 添加缓存以加速后续构建
        cache: true
        cache-key: cargo-${{ hashFiles('**/Cargo.lock') }}

    # 安装 cargo-deny 工具
    - name: Install cargo-deny
      run: cargo install cargo-deny --locked

    # 依赖安全检查
    - name: Run cargo deny
      run: cargo deny check

    # 基础编译检查
    - name: Run cargo check
      run: cargo check

    # 代码格式化检查
    - name: Run cargo fmt
      run: cargo fmt --all -- --check

    # Clippy Lint 检查
    - name: Run cargo clippy
      run: cargo clippy -- -D warnings

    # 运行测试
    - name: Run cargo test
      run: cargo test
